name: Build
on: [pull_request, push]
jobs:
  build:
    name: "Build"
    runs-on: ubuntu-24.04
    steps:
      - name: "Setup dependencies"
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-14-dev
          sudo apt-get install -y build-essential gettext libadwaita-1-dev libcanberra-dev libgcrypt20-dev libgee-0.8-dev libgpgme-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev libgstreamer1.0-dev libgtk-4-dev libnice-dev libnotify-dev libqrencode-dev libomemo-c-dev libsoup-3.0-dev libsqlite3-dev libsqlcipher-dev libsecret-1-dev libsrtp2-dev libgnutls28-dev libwebrtc-audio-processing-dev libdbusmenu-glib-dev meson valac pkg-config
      - name: "Check A/V dependency versions"
        run: |
          set -euo pipefail

          echo "pkg-config versions:"
          echo "- nice: $(pkg-config --modversion nice)"
          echo "- gstreamer-1.0: $(pkg-config --modversion gstreamer-1.0)"

          if pkg-config --exists gstreamer-webrtc-1.0; then
            echo "- gstreamer-webrtc-1.0: $(pkg-config --modversion gstreamer-webrtc-1.0)"
          else
            echo "::error::Missing gstreamer-webrtc-1.0 (expected from libgstreamer-plugins-bad1.0-dev)"
            exit 1
          fi

          apm_pc=""
          for pc in webrtc-audio-processing webrtc-audio-processing-2 webrtc-audio-processing-1; do
            if pkg-config --exists "$pc"; then
              apm_pc="$pc"
              break
            fi
          done
          if [ -z "$apm_pc" ]; then
            echo "::error::Missing webrtc-audio-processing pkg-config (expected from libwebrtc-audio-processing-dev or webrtc-audio-processing-2)"
            exit 1
          fi
          echo "- $apm_pc: $(pkg-config --modversion "$apm_pc")"

          nice_ver="$(pkg-config --modversion nice)"
          gst_ver="$(pkg-config --modversion gstreamer-1.0)"
          gst_webrtc_ver="$(pkg-config --modversion gstreamer-webrtc-1.0)"
          apm_ver="$(pkg-config --modversion "$apm_pc")"

          dpkg --compare-versions "$nice_ver" ge 0.1.23
          dpkg --compare-versions "$gst_ver" ge 1.24.0
          dpkg --compare-versions "$gst_webrtc_ver" ge 1.24.0
          dpkg --compare-versions "$apm_ver" ge 0.3.0
      - name: "Checkout sources"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Setup matchers"
        run: |
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/gcc-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/vala-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/meson-problem-matcher.json'
      - name: "Configure"
        run: meson setup build
      - name: "Build"
        run: meson compile -C build
      - name: "Test"
        run: meson test -C build
  build-vala-nightly:
    name: "Build with Vala Nightly"
    runs-on: ubuntu-24.04
    steps:
      - name: "Setup dependencies"
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-14-dev
          sudo apt-get install -y build-essential gettext libadwaita-1-dev libcanberra-dev libgcrypt20-dev libgee-0.8-dev libgpgme-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev libgstreamer1.0-dev libgtk-4-dev libnice-dev libnotify-dev libqrencode-dev libomemo-c-dev libsoup-3.0-dev libsqlite3-dev libsqlcipher-dev libsecret-1-dev libsrtp2-dev libgnutls28-dev libwebrtc-audio-processing-dev libdbusmenu-glib-dev meson valac pkg-config
      - name: "Check A/V dependency versions"
        run: |
          set -euo pipefail

          echo "pkg-config versions:"
          echo "- nice: $(pkg-config --modversion nice)"
          echo "- gstreamer-1.0: $(pkg-config --modversion gstreamer-1.0)"

          if pkg-config --exists gstreamer-webrtc-1.0; then
            echo "- gstreamer-webrtc-1.0: $(pkg-config --modversion gstreamer-webrtc-1.0)"
          else
            echo "::error::Missing gstreamer-webrtc-1.0 (expected from libgstreamer-plugins-bad1.0-dev)"
            exit 1
          fi

          apm_pc=""
          for pc in webrtc-audio-processing webrtc-audio-processing-2 webrtc-audio-processing-1; do
            if pkg-config --exists "$pc"; then
              apm_pc="$pc"
              break
            fi
          done
          if [ -z "$apm_pc" ]; then
            echo "::error::Missing webrtc-audio-processing pkg-config (expected from libwebrtc-audio-processing-dev or webrtc-audio-processing-2)"
            exit 1
          fi
          echo "- $apm_pc: $(pkg-config --modversion "$apm_pc")"

          nice_ver="$(pkg-config --modversion nice)"
          gst_ver="$(pkg-config --modversion gstreamer-1.0)"
          gst_webrtc_ver="$(pkg-config --modversion gstreamer-webrtc-1.0)"
          apm_ver="$(pkg-config --modversion "$apm_pc")"

          dpkg --compare-versions "$nice_ver" ge 0.1.23
          dpkg --compare-versions "$gst_ver" ge 1.24.0
          dpkg --compare-versions "$gst_webrtc_ver" ge 1.24.0
          dpkg --compare-versions "$apm_ver" ge 0.3.0
      - name: "Install Vala Nightly"
        run: |
          sudo apt-get install -y autoconf-archive gobject-introspection libgraphviz-dev
          git clone https://gitlab.gnome.org/GNOME/vala.git/ vala-nightly
          pushd vala-nightly
          ./autogen.sh --prefix=/usr
          make -j5
          sudo apt-get remove valac
          sudo apt-get autoremove
          sudo make install
          popd
          rm -rf vala-nightly
      - name: "Checkout sources"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Setup matchers"
        run: |
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/gcc-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/vala-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/meson-problem-matcher.json'
      - name: "Configure"
        run: meson setup build
      - name: "Build"
        run: meson compile -C build
      - name: "Test"
        run: meson test -C build
  build-flatpak:
    needs: build
    name: "Build Flatpak"
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged
    steps:
      - name: "Checkout sources"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Build"
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: im.github.rallep71.DinoX.json
          bundle: im.github.rallep71.DinoX.flatpak
          arch: x86_64
