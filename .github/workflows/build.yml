name: Build
on: [pull_request, push]
jobs:
  build:
    name: "Build"
    runs-on: ubuntu-24.04
    steps:
      - name: "Checkout sources"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Setup dependencies"
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-14-dev
          sudo apt-get install -y build-essential gettext cmake wget \
            libadwaita-1-dev libcanberra-dev libgcrypt20-dev libgee-0.8-dev \
            libgpgme-dev libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev libgstreamer1.0-dev libgtk-4-dev \
            libnice-dev libnotify-dev libqrencode-dev libsoup-3.0-dev \
            libsqlite3-dev libsqlcipher-dev libsecret-1-dev libsrtp2-dev \
            libgnutls28-dev libdbusmenu-glib-dev meson valac pkg-config \
            libjson-glib-dev \
            gstreamer1.0-plugins-good
      - name: "Cache custom dependencies"
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: ~/ci-deps-cache
          key: ci-deps-v2-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('scripts/ci-build-deps.sh') }}
      - name: "Restore cached dependencies"
        if: steps.cache-deps.outputs.cache-hit == 'true'
        run: |
          sudo tar xf ~/ci-deps-cache/deps.tar -C /
          sudo ldconfig
      - name: "Build custom dependencies"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          # Snapshot installed files before building custom deps
          cd / && find usr/lib usr/include usr/bin usr/share/gir-1.0 usr/share/vala \
            \( -type f -o -type l \) 2>/dev/null | sort > /tmp/files-before.txt
          cd "$GITHUB_WORKSPACE"
          chmod +x scripts/ci-build-deps.sh
          ./scripts/ci-build-deps.sh
          # Snapshot installed files after building custom deps
          cd / && find usr/lib usr/include usr/bin usr/share/gir-1.0 usr/share/vala \
            \( -type f -o -type l \) 2>/dev/null | sort > /tmp/files-after.txt
          # Capture new files (webrtc-audio-processing-2, libomemo-c are entirely new)
          comm -13 /tmp/files-before.txt /tmp/files-after.txt > /tmp/cache-files.txt
          # Also include dirs replaced by custom builds â€” meson install preserves
          # original file timestamps, so same-path replacements are invisible to
          # timestamp-based approaches.  Explicitly capture them:
          { find usr/include/nice usr/include/sqlcipher usr/include/protobuf-c \
              usr/include/mosquitto.h usr/include/mosquitto \
              \( -type f -o -type l \) 2>/dev/null || true
            find usr/lib -maxdepth 2 \( -name 'libnice*' -o -name 'libsqlcipher*' \
              -o -name 'libprotobuf-c*' -o -name 'libmosquitto*' \) \
              \( -type f -o -type l \) 2>/dev/null || true
            find usr/lib -maxdepth 3 -path '*/pkgconfig/*' \
              \( -name 'nice.pc' -o -name 'sqlcipher.pc' \
              -o -name 'libprotobuf-c.pc' -o -name 'libmosquitto.pc' \) \
              2>/dev/null || true
          } >> /tmp/cache-files.txt
          sort -u /tmp/cache-files.txt -o /tmp/cache-files.txt
          echo "::notice::Caching $(wc -l < /tmp/cache-files.txt) custom dependency files"
          mkdir -p ~/ci-deps-cache
          sudo tar cf ~/ci-deps-cache/deps.tar -T /tmp/cache-files.txt
      - name: "Check A/V dependency versions"
        run: |
          set -euo pipefail

          echo "pkg-config versions:"
          echo "- nice: $(pkg-config --modversion nice)"
          echo "- gstreamer-1.0: $(pkg-config --modversion gstreamer-1.0)"

          if pkg-config --exists gstreamer-webrtc-1.0; then
            echo "- gstreamer-webrtc-1.0: $(pkg-config --modversion gstreamer-webrtc-1.0)"
          else
            echo "::warning::gstreamer-webrtc-1.0 pkg-config not found (ok; not required for RTP/Jingle calls)"
          fi

          apm_pc=""
          for pc in webrtc-audio-processing-2 webrtc-audio-processing-1 webrtc-audio-processing; do
            if pkg-config --exists "$pc"; then
              apm_pc="$pc"
              break
            fi
          done
          if [ -n "$apm_pc" ]; then
            echo "- $apm_pc: $(pkg-config --modversion "$apm_pc")"
          else
            echo "::warning::No webrtc-audio-processing pkg-config found (AEC/NS/AGC will be disabled; build remains functional)"
          fi

          nice_ver="$(pkg-config --modversion nice)"
          gst_ver="$(pkg-config --modversion gstreamer-1.0)"

          if [ -n "$apm_pc" ]; then
            apm_ver="$(pkg-config --modversion "$apm_pc")"
          else
            apm_ver="0"
          fi

          dpkg --compare-versions "$nice_ver" ge 0.1.21
          dpkg --compare-versions "$gst_ver" ge 1.24.0
          if [ "$apm_ver" != "0" ]; then
            dpkg --compare-versions "$apm_ver" ge 1.0
          fi
      - name: "Setup matchers"
        run: |
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/gcc-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/vala-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/meson-problem-matcher.json'
      - name: "Configure"
        run: meson setup build
      - name: "Build"
        run: meson compile -C build
      - name: "Test"
        run: meson test -C build
  build-vala-nightly:
    name: "Build with Vala Nightly"
    runs-on: ubuntu-24.04
    continue-on-error: true
    steps:
      - name: "Checkout sources"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Setup dependencies"
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-14-dev
          sudo apt-get install -y build-essential gettext cmake wget \
            libadwaita-1-dev libcanberra-dev libgcrypt20-dev libgee-0.8-dev \
            libgpgme-dev libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev libgstreamer1.0-dev libgtk-4-dev \
            libnice-dev libnotify-dev libqrencode-dev libsoup-3.0-dev \
            libsqlite3-dev libsqlcipher-dev libsecret-1-dev libsrtp2-dev \
            libgnutls28-dev libdbusmenu-glib-dev meson valac pkg-config \
            libjson-glib-dev \
            gstreamer1.0-plugins-good
      - name: "Cache custom dependencies"
        id: cache-deps-nightly
        uses: actions/cache@v4
        with:
          path: ~/ci-deps-cache
          key: ci-deps-v2-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('scripts/ci-build-deps.sh') }}
      - name: "Restore cached dependencies"
        if: steps.cache-deps-nightly.outputs.cache-hit == 'true'
        run: |
          sudo tar xf ~/ci-deps-cache/deps.tar -C /
          sudo ldconfig
      - name: "Build custom dependencies"
        if: steps.cache-deps-nightly.outputs.cache-hit != 'true'
        run: |
          cd / && find usr/lib usr/include usr/bin usr/share/gir-1.0 usr/share/vala \
            \( -type f -o -type l \) 2>/dev/null | sort > /tmp/files-before.txt
          cd "$GITHUB_WORKSPACE"
          chmod +x scripts/ci-build-deps.sh
          ./scripts/ci-build-deps.sh
          cd / && find usr/lib usr/include usr/bin usr/share/gir-1.0 usr/share/vala \
            \( -type f -o -type l \) 2>/dev/null | sort > /tmp/files-after.txt
          comm -13 /tmp/files-before.txt /tmp/files-after.txt > /tmp/cache-files.txt
          { find usr/include/nice usr/include/sqlcipher usr/include/protobuf-c \
              usr/include/mosquitto.h usr/include/mosquitto \
              \( -type f -o -type l \) 2>/dev/null || true
            find usr/lib -maxdepth 2 \( -name 'libnice*' -o -name 'libsqlcipher*' \
              -o -name 'libprotobuf-c*' -o -name 'libmosquitto*' \) \
              \( -type f -o -type l \) 2>/dev/null || true
            find usr/lib -maxdepth 3 -path '*/pkgconfig/*' \
              \( -name 'nice.pc' -o -name 'sqlcipher.pc' \
              -o -name 'libprotobuf-c.pc' -o -name 'libmosquitto.pc' \) \
              2>/dev/null || true
          } >> /tmp/cache-files.txt
          sort -u /tmp/cache-files.txt -o /tmp/cache-files.txt
          echo "::notice::Caching $(wc -l < /tmp/cache-files.txt) custom dependency files"
          mkdir -p ~/ci-deps-cache
          sudo tar cf ~/ci-deps-cache/deps.tar -T /tmp/cache-files.txt
      - name: "Get week number"
        id: week
        run: echo "week=$(date +%Y-W%V)" >> $GITHUB_OUTPUT
      - name: "Cache Vala Nightly"
        id: cache-vala
        uses: actions/cache@v4
        with:
          path: ~/vala-cache
          key: vala-nightly-${{ runner.os }}-${{ runner.arch }}-${{ steps.week.outputs.week }}
      - name: "Restore cached Vala Nightly"
        if: steps.cache-vala.outputs.cache-hit == 'true'
        run: |
          sudo apt-get remove -y valac && sudo apt-get autoremove -y
          sudo tar xf ~/vala-cache/vala.tar -C /
          sudo ldconfig
      - name: "Install Vala Nightly"
        if: steps.cache-vala.outputs.cache-hit != 'true'
        run: |
          sudo apt-get install -y autoconf-archive gobject-introspection libgraphviz-dev
          touch /tmp/vala-marker && sleep 1
          git clone --depth 1 https://gitlab.gnome.org/GNOME/vala.git/ vala-nightly
          pushd vala-nightly
          # Fetch tags so autogen.sh can determine version numbers
          git fetch --tags --depth=1 2>/dev/null || true
          ./autogen.sh --prefix=/usr
          make -j$(nproc)
          sudo apt-get remove -y valac && sudo apt-get autoremove -y
          sudo make install
          popd
          rm -rf vala-nightly
          mkdir -p ~/vala-cache
          cd / && sudo find usr/lib usr/include usr/bin usr/share usr/libexec \
            -newer /tmp/vala-marker \( -type f -o -type l \) 2>/dev/null | \
            sudo tar cf ~/vala-cache/vala.tar -T - 2>/dev/null || true
      - name: "Check A/V dependency versions"
        run: |
          set -euo pipefail

          echo "pkg-config versions:"
          echo "- nice: $(pkg-config --modversion nice)"
          echo "- gstreamer-1.0: $(pkg-config --modversion gstreamer-1.0)"

          if pkg-config --exists gstreamer-webrtc-1.0; then
            echo "- gstreamer-webrtc-1.0: $(pkg-config --modversion gstreamer-webrtc-1.0)"
          else
            echo "::warning::gstreamer-webrtc-1.0 pkg-config not found (ok; not required for RTP/Jingle calls)"
          fi

          apm_pc=""
          for pc in webrtc-audio-processing-2 webrtc-audio-processing-1 webrtc-audio-processing; do
            if pkg-config --exists "$pc"; then
              apm_pc="$pc"
              break
            fi
          done
          if [ -n "$apm_pc" ]; then
            echo "- $apm_pc: $(pkg-config --modversion "$apm_pc")"
          else
            echo "::warning::No webrtc-audio-processing pkg-config found (AEC/NS/AGC will be disabled; build remains functional)"
          fi

          nice_ver="$(pkg-config --modversion nice)"
          gst_ver="$(pkg-config --modversion gstreamer-1.0)"

          if [ -n "$apm_pc" ]; then
            apm_ver="$(pkg-config --modversion "$apm_pc")"
          else
            apm_ver="0"
          fi

          dpkg --compare-versions "$nice_ver" ge 0.1.21
          dpkg --compare-versions "$gst_ver" ge 1.24.0
          if [ "$apm_ver" != "0" ]; then
            dpkg --compare-versions "$apm_ver" ge 1.0
          fi
      - name: "Setup matchers"
        run: |
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/gcc-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/vala-problem-matcher.json'
          echo '::add-matcher::${{ github.workspace }}/.github/matchers/meson-problem-matcher.json'
      - name: "Configure"
        run: meson setup build
      - name: "Build"
        run: meson compile -C build
      - name: "Test"
        run: meson test -C build
  build-flatpak:
    needs: build
    name: "Build Flatpak"
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged
    steps:
      - name: "Checkout sources"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Build"
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: im.github.rallep71.DinoX.json
          bundle: im.github.rallep71.DinoX.flatpak
          arch: x86_64
          cache-key: flatpak-builder-${{ hashFiles('im.github.rallep71.DinoX.json') }}

      - name: "Upload Flatpak bundle"
        uses: actions/upload-artifact@v4
        with:
          name: im.github.rallep71.DinoX-flatpak-x86_64
          path: im.github.rallep71.DinoX.flatpak
          if-no-files-found: error
