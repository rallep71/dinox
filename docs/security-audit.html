<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Audit - DinoX</title>
    <meta name="description" content="DinoX cryptographic security audit results. 17 issues found and fixed across OMEMO, SASL, and Signal Protocol code.">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .audit-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; font-size: 0.95rem; }
        .audit-table th, .audit-table td { padding: 0.6rem 0.8rem; text-align: left; border-bottom: 1px solid var(--border-color, #333); }
        .audit-table th { font-weight: 600; }
        .audit-table tr:hover { background: rgba(53,132,228,0.06); }
        .severity-critical { color: #e01b24; font-weight: 700; }
        .severity-high { color: #ff7800; font-weight: 600; }
        .severity-medium { color: #f5c211; font-weight: 600; }
        .status-fixed { color: #26a269; font-weight: 600; }
        .status-wontfix { color: #888; }
        .audit-meta { display: flex; flex-wrap: wrap; gap: 2rem; margin: 1.5rem 0; padding: 1rem; background: rgba(53,132,228,0.08); border-radius: 8px; }
        .audit-meta div { min-width: 140px; }
        .audit-meta strong { display: block; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.2rem; }
        .code-ref { font-family: monospace; font-size: 0.9em; background: rgba(255,255,255,0.06); padding: 0.15em 0.4em; border-radius: 3px; }
        h3 { margin-top: 2.5rem; }
    </style>
</head>
<body>
    <a class="skip-link" href="#main">Skip to content</a>

    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="container">
            <a href="./" class="nav-brand">
                <img src="assets/icon.svg" alt="" class="logo" width="36" height="36">
                <span class="brand-name">DinoX</span>
            </a>
            <ul class="nav-menu">
                <li><a href="./#features">Features</a></li>
                <li><a href="./#download">Download</a></li>
                <li><a href="./#xep">XEP Support</a></li>
                <li><a href="./#donate">Support</a></li>
                <li><a href="./#docs">Docs</a></li>
                <li><a href="https://github.com/rallep71/dinox">GitHub</a></li>
            </ul>
            <div class="lang-switcher-wrapper" role="listbox" aria-label="Language">
                <div class="lang-switcher">
                    <button type="button" class="lang-btn active" data-lang="en" role="option" aria-selected="true">EN</button>
                    <button type="button" class="lang-btn" data-lang="de" role="option" aria-selected="false">DE</button>
                    <button type="button" class="lang-btn" data-lang="fr" role="option" aria-selected="false">FR</button>
                    <button type="button" class="lang-btn" data-lang="es" role="option" aria-selected="false">ES</button>
                </div>
            </div>
            <div class="nav-actions">
                <button type="button" class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <button type="button" class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menu" aria-expanded="false" aria-controls="mobileMenu">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
        <div class="mobile-menu" id="mobileMenu">
            <a href="./#features">Features</a>
            <a href="./#download">Download</a>
            <a href="./#xep">XEP Support</a>
            <a href="./#donate">Support</a>
            <a href="./#docs">Docs</a>
            <a href="https://github.com/rallep71/dinox">GitHub</a>
        </div>
    </nav>

    <main id="main" tabindex="-1">
        <section class="features">
            <div class="container">
                <div class="feature-card">

                    <h1>Security Audit</h1>
                    <p>
                        In February 2026, a comprehensive security audit was performed on all cryptographic code
                        in DinoX. The audit covered OMEMO v1/v2 encryption, the Signal Protocol crypto provider,
                        SASL authentication, file transfer encryption, and the underlying GCrypt wrapper library.
                        <strong>All critical, medium, and low-severity issues have been fixed.</strong>
                    </p>

                    <div class="audit-meta">
                        <div><strong>Date</strong> February 17, 2026</div>
                        <div><strong>Scope</strong> 39 crypto-related files + 15 OpenPGP files</div>
                        <div><strong>Findings</strong> 6 Critical/High, 11 Medium, 3 Low + 3 OpenPGP</div>
                        <div><strong>Status</strong> <span class="status-fixed">All fixed</span></div>
                        <div><strong>Commits</strong>
                            <a href="https://github.com/rallep71/dinox/commit/08c895f6">08c895f6</a>,
                            <a href="https://github.com/rallep71/dinox/commit/83fa5046">83fa5046</a>,
                            <a href="https://github.com/rallep71/dinox/commit/525115d9">525115d9</a>
                        </div>
                    </div>

                    <!-- ============================================================ -->
                    <h2>About helper.c</h2>
                    <p>
                        The file <span class="code-ref">plugins/omemo/src/native/helper.c</span> provides
                        GCrypt-based cryptographic callbacks (HMAC-SHA256, SHA-512, AES encrypt/decrypt, random)
                        that are registered as the <strong>Signal Protocol crypto provider</strong> for
                        libomemo-c (formerly libsignal-protocol-c).
                    </p>
                    <p>
                        This file originates from the <strong>original Dino project</strong>, authored by
                        <strong>Marvin W</strong> (core Dino developer) on March 11, 2017, as
                        <span class="code-ref">plugins/signal-protocol/src/signal_helper.c</span>.
                        It has been maintained and renamed twice through Dino's evolution:
                    </p>
                    <ul>
                        <li>2023: moved to <span class="code-ref">plugins/omemo/src/signal/signal_helper.c</span></li>
                        <li>2025: renamed to <span class="code-ref">plugins/omemo/src/native/helper.c</span></li>
                    </ul>
                    <p>
                        The file is written in C (not Vala) because libomemo-c requires a
                        <span class="code-ref">signal_crypto_provider</span> struct with C function pointers.
                        This is standard practice &mdash; every XMPP client using libsignal has equivalent glue code.
                    </p>
                    <p>
                        <strong>Note:</strong> Several critical bugs found in this file (the <code>free(md)</code>
                        heap corruption and the <code>sizeof(gcry_mac_hd_t)</code> type mismatch) are present in
                        the <strong>original upstream Dino codebase</strong> as of the audit date and have not been
                        reported or fixed there. The OMEMO v2 functions (<code>omemo2_hkdf_sha256</code>,
                        <code>omemo2_aes_256_cbc_pkcs7_encrypt/decrypt</code>) were added in the DinoX fork.
                    </p>

                    <!-- ============================================================ -->
                    <h2>Critical &amp; High Severity (Fixed)</h2>
                    <table class="audit-table">
                        <thead>
                            <tr><th>#</th><th>Severity</th><th>File</th><th>Issue</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td class="severity-critical">CRITICAL</td>
                                <td><span class="code-ref">helper.c:159</span></td>
                                <td>
                                    <strong>Heap corruption: <code>free(md)</code> on <code>gcry_md_read()</code> internal pointer.</strong>
                                    <code>gcry_md_read()</code> returns a pointer to an internal buffer &mdash; calling <code>free()</code>
                                    on it corrupts the heap. Also present in upstream Dino.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td class="severity-critical">CRITICAL</td>
                                <td><span class="code-ref">helper.c:86-89</span></td>
                                <td>
                                    <strong>Resource leak: missing <code>gcry_mac_close()</code> on setkey failure.</strong>
                                    When <code>gcry_mac_setkey()</code> fails, the HMAC context was freed with <code>free(ctx)</code>
                                    but <code>gcry_mac_close(*ctx)</code> was not called first, leaking GCrypt internal state.
                                    Also present in upstream Dino.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td class="severity-critical">CRITICAL</td>
                                <td><span class="code-ref">helper.c:343-345</span></td>
                                <td>
                                    <strong>Incomplete PKCS#5 padding validation.</strong>
                                    Only the last byte of the padding was checked. An attacker could craft ciphertext
                                    with invalid interior padding bytes that would be accepted. Fixed with constant-time
                                    XOR-accumulator verifying all padding bytes.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td class="severity-high">HIGH</td>
                                <td><span class="code-ref">simple_iks.vala:33-36</span></td>
                                <td>
                                    <strong>Timing attack: non-constant-time identity key comparison.</strong>
                                    Early-return byte comparison leaked key data via timing side channels.
                                    Fixed with XOR-OR accumulator pattern.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td class="severity-high">HIGH</td>
                                <td><span class="code-ref">sasl.vala:110-113</span></td>
                                <td>
                                    <strong>Timing attack: non-constant-time SCRAM server signature verification.</strong>
                                    Same early-return pattern in SASL SCRAM-SHA-1 server signature check.
                                    Fixed with XOR-OR accumulator.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td class="severity-high">HIGH</td>
                                <td><span class="code-ref">helper.c:128</span></td>
                                <td>
                                    <strong>Type mismatch: <code>sizeof(gcry_mac_hd_t)</code> instead of <code>sizeof(gcry_md_hd_t)</code></strong>
                                    in SHA-512 digest init. The wrong type size was used for the allocation.
                                    Also present in upstream Dino.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>Medium Severity (Fixed)</h2>
                    <table class="audit-table">
                        <thead>
                            <tr><th>#</th><th>File</th><th>Issue</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>7</td>
                                <td><span class="code-ref">file_decryptor.vala</span></td>
                                <td>
                                    <strong>Empty cipher URI defaulted to unauthenticated GCM.</strong>
                                    An empty or unknown ESFS cipher string silently fell through to GCM without
                                    auth tag verification. Now rejects unknown cipher URIs.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>8</td>
                                <td><span class="code-ref">decrypt.vala</span></td>
                                <td>
                                    <strong>Loose key length validation.</strong>
                                    Accepted any key &ge;32 bytes. Now enforces exactly 16 or 32 bytes
                                    per OMEMO specification.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>9</td>
                                <td><span class="code-ref">encrypt.vala</span></td>
                                <td>
                                    <strong>Key material not zeroized after use (OMEMO v1).</strong>
                                    AES key and IV remained in heap memory after encryption.
                                    Now explicitly zeroed with <code>Memory.set()</code>.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>10</td>
                                <td><span class="code-ref">encrypt_v2.vala</span></td>
                                <td>
                                    <strong>Key material not zeroized after use (OMEMO v2).</strong>
                                    Message key, HKDF output, encryption key, and auth key
                                    remained in heap. Now zeroed after use.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>11</td>
                                <td><span class="code-ref">helper.c (HKDF)</span></td>
                                <td>
                                    <strong>HKDF intermediate keys not zeroized.</strong>
                                    Stack-allocated <code>prk</code> and <code>t_prev</code> were not cleared
                                    on return, leaving key derivation material recoverable.
                                    All exit paths now zeroize via <code>goto cleanup</code>.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>12</td>
                                <td><span class="code-ref">helper.c (omemo2 CBC)</span></td>
                                <td>
                                    <strong>Non-constant-time PKCS#7 padding check in OMEMO v2 decrypt.</strong>
                                    Early-exit loop leaked padding length via timing (padding oracle risk).
                                    Replaced with constant-time XOR-accumulator.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>13</td>
                                <td><span class="code-ref">cipher.vala</span></td>
                                <td>
                                    <strong>ECB mode available in cipher API.</strong>
                                    ECB provides no semantic security. Now logs a warning when ECB is requested.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>14</td>
                                <td><span class="code-ref">sasl.vala</span></td>
                                <td>
                                    <strong>PLAIN authentication sent without TLS check.</strong>
                                    Cleartext password could be sent over unencrypted connection.
                                    Now refuses PLAIN auth unless the stream is a TLS connection.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>15</td>
                                <td><span class="code-ref">sasl.vala</span></td>
                                <td>
                                    <strong>No minimum PBKDF2 iteration count.</strong>
                                    A malicious server could specify iteration count of 1 for SCRAM.
                                    Now enforces a minimum of 4096 iterations per RFC 5802 recommendation.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>16</td>
                                <td><span class="code-ref">file_decryptor.vala</span></td>
                                <td>
                                    <strong>GCM decryption without auth tag verification.</strong>
                                    ESFS GCM mode used tag length 0 for Kaidan/QXmpp interop.
                                    Now logs a warning. Full auth tag enforcement deferred for interoperability.
                                </td>
                                <td class="status-fixed">Fixed (warning)</td>
                            </tr>
                            <tr>
                                <td>17</td>
                                <td><span class="code-ref">decrypt.vala</span></td>
                                <td>
                                    <strong>Incomplete session finalization after pre-key decrypt.</strong>
                                    A <code>TODO</code> comment suggested the session was not properly finalized.
                                    Clarified that Signal sessions auto-transition after pre-key decryption.
                                </td>
                                <td class="status-fixed">Fixed (clarified)</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>Low Severity (Fixed)</h2>
                    <table class="audit-table">
                        <thead>
                            <tr><th>#</th><th>File</th><th>Issue</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>18</td>
                                <td><span class="code-ref">helper.c (omemo2 CBC)</span></td>
                                <td>
                                    <strong>Decrypted plaintext not zeroized before free.</strong>
                                    After copying the unpadded result, the full decrypted buffer
                                    (including padding) was freed with <code>g_free()</code> without
                                    clearing. Now <code>memset(decrypted, 0, ciphertext_len)</code>
                                    on all exit paths.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>19</td>
                                <td><span class="code-ref">helper.c (omemo2 HMAC)</span></td>
                                <td>
                                    <strong>Full HMAC not zeroized on stack.</strong>
                                    <code>omemo2_hmac_sha256()</code> computed a full 32-byte MAC
                                    into a stack buffer, copied the truncated result, but did not
                                    clear the full MAC before return. Now
                                    <code>memset(full_mac, 0, sizeof(full_mac))</code> after truncation.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                            <tr>
                                <td>20</td>
                                <td><span class="code-ref">sce.vala</span></td>
                                <td>
                                    <strong>Random padding used Mersenne Twister.</strong>
                                    <code>generate_rpad()</code> used <code>GLib.Random</code> (MT19937)
                                    which is not a CSPRNG. An attacker recovering the MT state could
                                    predict padding lengths, leaking minor traffic analysis information.
                                    Now uses <code>/dev/urandom</code> directly, with GLib.Random as fallback.
                                </td>
                                <td class="status-fixed">Fixed</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>OMEMO v2 Implementation Security</h2>
                    <p>
                        DinoX is one of the first desktop XMPP clients to implement <strong>OMEMO v2</strong>
                        (XEP-0384 v0.8+) alongside the legacy OMEMO protocol (v0.3.x). The implementation
                        was developed and debugged through interoperability testing with
                        <strong>Kaidan</strong> (which uses the QXmpp library), as well as Conversations
                        and Monocles for legacy OMEMO backward compatibility.
                    </p>

                    <h3>Crypto Architecture</h3>
                    <p>OMEMO v2 uses a fundamentally different encryption scheme than legacy OMEMO:</p>
                    <table class="audit-table">
                        <thead>
                            <tr><th>Aspect</th><th>Legacy OMEMO</th><th>OMEMO v2</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Payload cipher</td><td>AES-128-GCM (16-byte key, 12-byte IV)</td><td>AES-256-CBC + HMAC-SHA-256 via HKDF</td></tr>
                            <tr><td>Key derivation</td><td>Direct key use</td><td>HKDF-SHA-256 (salt=256 zero-bits, info=<code>"OMEMO Payload"</code>) &rarr; 80 bytes</td></tr>
                            <tr><td>Per-device key material</td><td>32 bytes (key + GCM auth tag)</td><td>48 bytes (32-byte key + 16-byte HMAC)</td></tr>
                            <tr><td>Content wrapping</td><td>Plaintext body</td><td>SCE envelope (XEP-0420) with random padding</td></tr>
                            <tr><td>Wire format</td><td>DJB-serialized keys (0x05 prefix)</td><td>Bare X25519/Ed25519 keys</td></tr>
                            <tr><td>Identity key format</td><td>Curve25519 (Montgomery)</td><td>Ed25519 (with Montgomery conversion for DH)</td></tr>
                        </tbody>
                    </table>
                    <p>
                        All OMEMO v2 cryptographic primitives were implemented in
                        <span class="code-ref">helper.c</span> using libgcrypt:
                        <code>omemo2_hkdf_sha256()</code>,
                        <code>omemo2_aes_256_cbc_pkcs7_encrypt/decrypt()</code>,
                        <code>omemo2_hmac_sha256()</code>.
                    </p>

                    <h3>Kaidan Interoperability: Issues Found and Fixed</h3>
                    <p>
                        The following interop issues were discovered and resolved during testing with Kaidan:
                    </p>

                    <h4>1. Ed25519 Identity Key Decoding</h4>
                    <p>
                        OMEMO v2 bundles carry the identity key in <strong>Ed25519 format</strong>,
                        not Montgomery/X25519. Initially DinoX decoded the identity key with
                        <code>decode_public_key_mont()</code>, which silently produced wrong key material.
                        Sessions appeared to establish but messages were undecryptable. Fixed by switching to
                        <code>decode_public_key()</code> which correctly handles Ed25519-to-Montgomery
                        conversion for ECDH while preserving Ed25519 data for XEdDSA signature verification.
                        (<span class="code-ref">bundle_v2.vala</span>,
                        <a href="https://github.com/rallep71/dinox/commit/620b0e24">620b0e24</a>)
                    </p>

                    <h4>2. OMEMO v1/v2 Session Conflict</h4>
                    <p>
                        Both protocol versions share the same libomemo-c session store. When a v2 bundle
                        arrived first, it created a <code>builder.version&nbsp;=&nbsp;4</code> session.
                        The v1 encryptor then used this v4 session without setting <code>cipher.version</code>,
                        producing messages with a broken version byte that receivers rejected as
                        <code>SG_ERR_LEGACY_MESSAGE</code>. Fixed by preventing v2 session creation for
                        JIDs with v1 devices, replacing v4 sessions with v3 in v1 <code>start_session()</code>,
                        and using v2 encryptor only when all recipients support v2.
                        (<span class="code-ref">manager.vala</span>,
                        <a href="https://github.com/rallep71/dinox/commit/40bcb7db">40bcb7db</a>)
                    </p>

                    <h4>3. v2 Device List Wiping v1 Devices</h4>
                    <p>
                        The v1 device list handler used destructive <code>insert_device_list()</code>
                        which deactivates all devices before re-inserting active ones. When applied to an
                        empty v2 device list from a v1-only client, all devices were deactivated and
                        <code>get_trusted_devices()</code> returned empty. Fixed with an additive
                        <code>insert_device_list_additive()</code> that never deactivates devices.
                    </p>

                    <h4>4. GCM Auth Tag Mismatch for File Transfers</h4>
                    <p>
                        ESFS file transfers (OMEMO v2) use <code>aes-256-gcm-nopadding:0</code> with no
                        GCM auth tag. Legacy <code>aesgcm://</code> transfers append a 16-byte tag. Both
                        paths shared the same upload code, causing Kaidan to report "checksum mismatch".
                        Fixed with an <code>esfs_mode</code> flag controlling tag length and an ESFS JID
                        registry for cross-plugin communication.
                    </p>

                    <h4>5. HTTP 413 on ESFS File Uploads</h4>
                    <p>
                        Upload slots were always requested with <code>file_size&nbsp;+&nbsp;16</code> for
                        the GCM tag, but ESFS uploads have <code>tag_len&nbsp;=&nbsp;0</code>. The server
                        rejected the Content-Length mismatch with HTTP 413. Fixed by checking the ESFS
                        JID registry before requesting the slot.
                    </p>

                    <h4>6. Bundle Retry for Broken Bundles</h4>
                    <p>
                        Kaidan sometimes publishes bundles with empty <code>&lt;ik/&gt;</code> elements
                        (no identity key content). These broken bundles were silently accepted, creating
                        devices with <code>identity_key&nbsp;=&nbsp;null</code> that blocked all encryption.
                        Fixed with a retry mechanism (up to 5 attempts, 10-minute intervals) and by marking
                        devices with broken bundles as &ldquo;lost&rdquo; so messages still flow to other devices.
                        (<a href="https://github.com/rallep71/dinox/commit/cc0abe1b">cc0abe1b</a>)
                    </p>

                    <h4>7. Undecryptable Message Storage</h4>
                    <p>
                        When OMEMO decryption fails, the sender's fallback body
                        <code>[This message is OMEMO encrypted]</code> was stored as a normal plaintext
                        message, creating ghost messages. Fixed by clearing <code>message.body</code>
                        when OMEMO decryption fails, allowing the message filter to drop it.
                        (<a href="https://github.com/rallep71/dinox/commit/65530687">65530687</a>)
                    </p>

                    <h4>8. Session Auto-Repair</h4>
                    <p>
                        <code>SG_ERR_INVALID_MESSAGE</code> errors (ratchet desync) caused permanent
                        message loss. Fixed with automatic session repair: broken sessions are deleted
                        and the peer's bundle is re-fetched to establish a new session. A per-device
                        HashSet guard prevents thrashing (one repair per device per runtime).
                        (<a href="https://github.com/rallep71/dinox/commit/de3de171">de3de171</a>)
                    </p>

                    <h3>OMEMO v2 Security Hardening (from this audit)</h3>
                    <p>During the February 2026 audit, the following OMEMO v2-specific issues were addressed:</p>
                    <ul>
                        <li><strong>Key zeroization (#10):</strong> Message key, HKDF output, encryption key, and auth key in <span class="code-ref">encrypt_v2.vala</span> are now explicitly zeroed after use</li>
                        <li><strong>HKDF intermediate key zeroization (#11):</strong> <code>prk</code> and <code>t_prev</code> in <span class="code-ref">helper.c</span> HKDF implementation cleared on all exit paths</li>
                        <li><strong>Constant-time PKCS#7 validation (#12):</strong> Padding check in <code>omemo2_aes_256_cbc_pkcs7_decrypt()</code> replaced with constant-time XOR-accumulator to prevent padding oracle attacks</li>
                        <li><strong>Strict key length validation (#8):</strong> Decryptor rejects key material that is not exactly 16 or 32 bytes</li>
                        <li><strong>Unknown cipher rejection (#7):</strong> ESFS file transfers with empty or unrecognized cipher URIs are now rejected instead of silently defaulting to unauthenticated GCM</li>
                        <li><strong>CBC decrypt buffer zeroization (#18):</strong> Decrypted plaintext buffer in <code>omemo2_aes_256_cbc_pkcs7_decrypt()</code> now zeroized before <code>g_free()</code> on all exit paths</li>
                        <li><strong>HMAC stack buffer zeroization (#19):</strong> Full 32-byte MAC in <code>omemo2_hmac_sha256()</code> cleared after truncation to prevent stack recovery</li>
                        <li><strong>SCE rpad CSPRNG (#20):</strong> Random padding generation in <code>sce.vala</code> now uses <code>/dev/urandom</code> instead of Mersenne Twister to prevent padding length prediction</li>
                    </ul>

                    <h3>Dual-Protocol Design</h3>
                    <p>DinoX runs both OMEMO v1 and v2 simultaneously with shared infrastructure:</p>
                    <ul>
                        <li>Same identity key pair and device ID for both protocols</li>
                        <li>Same libomemo-c session store (<code>builder.version&nbsp;=&nbsp;4</code> for v2 sessions)</li>
                        <li>Separate PEP nodes for device lists and bundles</li>
                        <li>Automatic protocol selection: v2 when all recipients support it, v1 otherwise</li>
                        <li>Trust is per identity key, independent of protocol version</li>
                    </ul>

                    <h3>Testing Matrix</h3>
                    <table class="audit-table">
                        <thead>
                            <tr><th>Test</th><th>Protocol</th><th>Tested Against</th><th>Result</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Text send/receive</td><td>OMEMO v2</td><td>Kaidan</td><td class="status-fixed">Pass</td></tr>
                            <tr><td>File send/receive (ESFS/SFS)</td><td>OMEMO v2</td><td>Kaidan</td><td class="status-fixed">Pass</td></tr>
                            <tr><td>Text send/receive</td><td>OMEMO v1</td><td>Monocles/Conversations</td><td class="status-fixed">Pass</td></tr>
                            <tr><td>File send/receive (aesgcm://)</td><td>OMEMO v1</td><td>Monocles</td><td class="status-fixed">Pass</td></tr>
                            <tr><td>Simultaneous v1+v2 operation</td><td>Both</td><td>Mixed</td><td class="status-fixed">Pass</td></tr>
                            <tr><td>Device list coexistence</td><td>Both</td><td>Mixed</td><td class="status-fixed">Pass</td></tr>
                            <tr><td>MUC OMEMO (v1+v2 version selection)</td><td>Both</td><td>Mixed</td><td class="status-fixed">Pass</td></tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>OpenPGP Implementation Security</h2>
                    <p>
                        DinoX implements <strong>XEP-0027</strong> (legacy PGP), <strong>XEP-0373</strong>
                        (OpenPGP key distribution via PubSub), and <strong>XEP-0374</strong> (OpenPGP for
                        XMPP Instant Messaging) with automatic protocol selection. GPG operations are
                        serialized through a single worker thread to prevent race conditions.
                    </p>

                    <h3>Architecture</h3>
                    <ul>
                        <li><strong>GPG CLI backend</strong> (<code>gpg_cli_helper.vala</code>, 1474 lines)
                            &mdash; all crypto delegates to the system <code>gpg</code> binary, avoiding GPGME issues on Windows.</li>
                        <li><strong>Worker queue</strong> &mdash; single background thread serializes all GPG subprocess calls,
                            preventing deadlocks and concurrent-spawn crashes.</li>
                        <li><strong>App-scoped keyring</strong> &mdash; <code>$STORAGE/openpgp/gnupg</code> (0700),
                            isolated from <code>~/.gnupg</code>. Enables clean Panic Wipe.</li>
                        <li><strong>Dual-protocol encryption</strong> &mdash; XEP-0374 signcrypt for contacts with
                            Service Discovery support; XEP-0027 fallback for all others.</li>
                    </ul>

                    <h3>Audited Files (15)</h3>
                    <table class="audit-table">
                        <thead><tr><th>File</th><th>Purpose</th></tr></thead>
                        <tbody>
                            <tr><td><code>gpg_cli_helper.vala</code></td><td>GPG subprocess wrapper (encrypt, decrypt, sign, verify, key management)</td></tr>
                            <tr><td><code>gpgme_fix.c</code> / <code>gpgme_fix.h</code></td><td>Windows stdio fix, GPGME key ref/unref</td></tr>
                            <tr><td><code>stream_module.vala</code></td><td>XEP-0027/0374 message encrypt/decrypt, presence signing</td></tr>
                            <tr><td><code>manager.vala</code></td><td>Encryption orchestration, key cache, keyserver auto-fetch</td></tr>
                            <tr><td><code>plugin.vala</code></td><td>Plugin lifecycle, gpg-agent config, module registration</td></tr>
                            <tr><td><code>database.vala</code></td><td>Key storage (SQLite), account/contact key mapping</td></tr>
                            <tr><td><code>xep0373_key_manager.vala</code></td><td>XEP-0373 PubSub key publishing and retrieval</td></tr>
                            <tr><td><code>file_encryptor.vala</code></td><td>GPG file encryption for HTTP upload</td></tr>
                            <tr><td><code>file_decryptor.vala</code></td><td>GPG file decryption</td></tr>
                            <tr><td><code>0373_openpgp.vala</code></td><td>XEP-0373 XMPP module (PEP key distribution)</td></tr>
                            <tr><td><code>0374_openpgp_content.vala</code></td><td>XEP-0374 content elements (signcrypt, sign, crypt)</td></tr>
                            <tr><td><code>stream_flag.vala</code></td><td>Per-JID key ID storage</td></tr>
                            <tr><td><code>encryption_list_entry.vala</code></td><td>UI integration for encryption activation</td></tr>
                            <tr><td><code>key_management_dialog.vala</code></td><td>Key generation/import/export/revocation UI</td></tr>
                            <tr><td><code>util.vala</code></td><td>Fingerprint formatting</td></tr>
                        </tbody>
                    </table>

                    <h3>OpenPGP Findings (Fixed)</h3>
                    <table class="audit-table">
                        <thead><tr><th>#</th><th>Severity</th><th>File(s)</th><th>Issue</th></tr></thead>
                        <tbody>
                            <tr>
                                <td>21</td>
                                <td class="severity-medium">Medium</td>
                                <td><code>gpg_cli_helper.vala</code></td>
                                <td><strong>Temp files containing plaintext not securely wiped.</strong>
                                    All GPG subprocess operations wrote sensitive data (plaintext messages,
                                    decrypted content, key material) to <code>/tmp</code> and deleted with
                                    <code>FileUtils.remove()</code> (simple <code>unlink()</code>). Deleted data
                                    remains on disk until overwritten by chance. Now <code>secure_delete_file()</code>
                                    overwrites with zeros before unlinking.</td>
                            </tr>
                            <tr>
                                <td>22</td>
                                <td class="severity-medium">Medium</td>
                                <td><code>gpg_cli_helper.vala</code> + <code>file_encryptor.vala</code></td>
                                <td><strong>Temp files created with permissive permissions.</strong>
                                    <code>FileUtils.set_contents()</code> creates files 0644 (umask-dependent),
                                    allowing other local users to read sensitive plaintext. Now
                                    <code>secure_write_file()</code> uses <code>FileCreateFlags.PRIVATE</code>
                                    (0600) and atomic creation (fails if file exists, preventing TOCTOU).</td>
                            </tr>
                            <tr>
                                <td>23</td>
                                <td>Low</td>
                                <td><code>0374_openpgp_content.vala</code></td>
                                <td><strong>XEP-0374 rpad uses Mersenne Twister.</strong>
                                    <code>generate_random_padding()</code> used <code>GLib.Random.int_range()</code>
                                    (MT19937) for random padding bytes. Now uses <code>/dev/urandom</code>
                                    (CSPRNG) with GLib.Random fallback. Same as OMEMO finding #20.</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>OpenPGP Security Properties (Verified)</h3>
                    <table class="audit-table">
                        <thead><tr><th>Property</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr><td>GPG subprocess serialization (worker queue)</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>App-scoped keyring isolation (0700 permissions)</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>XEP-0373 key import validation (armor check, base64, radix64 reject)</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>XEP-0027 signature verification (VALIDSIG/GOODSIG/ERRSIG)</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>MDC enforcement (batch mode: DECRYPTION_OKAY/GOODMDC required)</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>Base64url injection prevention (<code>-</code> and <code>_</code> rejected)</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>Key revocation and PubSub unpublish</td><td class="status-fixed">Correct</td></tr>
                            <tr><td>Sensitive debug logging (no key material leaked)</td><td class="status-fixed">OK</td></tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>Known Limitations (Not Fixed)</h2>
                    <p>
                        The following items were identified but intentionally not addressed, as they require
                        significant architectural changes or have negligible practical risk:
                    </p>
                    <table class="audit-table">
                        <thead>
                            <tr><th>Item</th><th>Risk</th><th>Rationale</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><s>SCRAM-SHA-1-PLUS channel binding</s></td>
                                <td class="severity-medium"><s>Medium</s></td>
                                <td>
                                    <strong>Fixed in v1.1.0.6.</strong> SCRAM-SHA-1-PLUS, SCRAM-SHA-256-PLUS, and
                                    SCRAM-SHA-512-PLUS implemented with <code>tls-exporter</code> (RFC 9266, GLib 2.74+)
                                    and <code>tls-server-end-point</code> (RFC 5929, GLib 2.66+) channel binding.
                                    Per-account downgrade protection toggle refuses login if server strips -PLUS
                                    mechanisms (possible MITM). DinoX is the only XMPP client supporting all six
                                    SCRAM variants.
                                </td>
                            </tr>
                            <tr>
                                <td><s>SCRAM-SHA-256 support</s></td>
                                <td class="severity-medium"><s>Medium</s></td>
                                <td>
                                    <strong>Fixed in v1.1.0.6.</strong> SCRAM-SHA-256 and SCRAM-SHA-512 implemented alongside SCRAM-SHA-1.
                                    Preference order: SHA-512 &gt; SHA-256 &gt; SHA-1.
                                </td>
                            </tr>
                            <tr>
                                <td><s>SCRAM nonce uses GLib.Random</s></td>
                                <td><s>Low</s></td>
                                <td>
                                    <strong>Fixed in v1.1.0.6.</strong> Nonce generation replaced with
                                    <code>/dev/urandom</code> CSPRNG (24 bytes, Base64-encoded).
                                    Fallback to GLib.Random on systems without <code>/dev/urandom</code>.
                                </td>
                            </tr>
                            <tr>
                                <td>OpenPGP interactive-mode MDC check</td>
                                <td>Low</td>
                                <td>
                                    In interactive decrypt mode (pinentry), GPG status output cannot be captured,
                                    so MDC status is not verified by DinoX. Mitigated by GPG 2.2+ enforcing MDC
                                    by default.
                                </td>
                            </tr>
                            <tr>
                                <td>Vala string zeroization</td>
                                <td>Info</td>
                                <td>
                                    Vala/GLib strings are garbage-collected, never zeroized in memory. Language
                                    limitation, not fixable without C interop. Applies to both OMEMO and OpenPGP.
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>SCRAM Channel Binding Support Across XMPP Clients</h2>
                    <table class="audit-table">
                        <thead>
                            <tr><th>Client</th><th>SCRAM-SHA-1</th><th>SCRAM-SHA-1-PLUS</th><th>SCRAM-SHA-256</th><th>SCRAM-SHA-256-PLUS</th><th>SCRAM-SHA-512</th><th>SCRAM-SHA-512-PLUS</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Conversations</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td>Monal</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td>Gajim</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td>Profanity</td><td>Yes</td><td>Yes</td><td>Partial</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td>Siskin IM</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td><strong>DinoX</strong></td><td><strong>Yes</strong></td><td><strong>Yes</strong></td><td><strong>Yes</strong></td><td><strong>Yes</strong></td><td><strong>Yes</strong></td><td><strong>Yes</strong></td></tr>
                            <tr><td>Dino (original)</td><td>Yes</td><td>No</td><td>No</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td>Kaidan</td><td>Yes</td><td>Limited</td><td>Yes</td><td>No</td><td>No</td><td>No</td></tr>
                            <tr><td>Pidgin / Swift / Psi</td><td>Yes</td><td>No</td><td>No</td><td>No</td><td>No</td><td>No</td></tr>
                        </tbody>
                    </table>

                    <!-- ============================================================ -->
                    <h2>Upstream Dino Bugs</h2>
                    <p>
                        The following bugs found during this audit also exist in the
                        <strong>original Dino codebase</strong>
                        (<a href="https://github.com/dino/dino">github.com/dino/dino</a>)
                        in the file <span class="code-ref">plugins/omemo/src/native/helper.c</span>
                        (formerly <span class="code-ref">signal_helper.c</span>):
                    </p>
                    <ul>
                        <li>
                            <strong>#1 &mdash; <code>free(md)</code> after <code>gcry_md_read()</code></strong>:
                            <code>gcry_md_read()</code> returns an internal pointer that must not be freed.
                            This causes heap corruption.
                        </li>
                        <li>
                            <strong>#2 &mdash; Missing <code>gcry_mac_close()</code></strong>:
                            On <code>gcry_mac_setkey()</code> failure, the GCrypt MAC handle is not closed
                            before the context pointer is freed.
                        </li>
                        <li>
                            <strong>#6 &mdash; <code>sizeof(gcry_mac_hd_t)</code> vs <code>sizeof(gcry_md_hd_t)</code></strong>:
                            Wrong type used in <code>malloc()</code> for the SHA-512 digest context allocation.
                        </li>
                    </ul>
                    <p>
                        These bugs have been present since the file was first written in 2017.
                        They are <strong>not introduced by DinoX</strong>.
                    </p>

                    <p style="margin-top: 2.5rem;">
                        <a class="btn btn-secondary" href="./">Back to home</a>
                        <a class="btn btn-secondary" href="https://github.com/rallep71/dinox/commit/08c895f6">View critical fixes</a>
                        <a class="btn btn-secondary" href="https://github.com/rallep71/dinox/commit/83fa5046">View medium fixes</a>
                    </p>

                </div>
            </div>
        </section>
    </main>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div class="footer-bottom">
                <p>
                    &copy; 2025&ndash;2026 Ralf Peter. Licensed under <a href="https://github.com/rallep71/dinox/blob/master/LICENSE">GPLv3</a>.
                    &middot; <a href="impressum.html">Imprint</a>
                    &middot; <a href="privacy.html">Privacy Policy</a>
                    &middot; <a href="donations.html">Donations &amp; transparency</a>
                </p>
            </div>
        </div>
    </footer>

    <div id="google_translate_element" aria-hidden="true"></div>
    <script src="js/main.js"></script>
</body>
</html>
